#!/bin/bash
# author: Lukas Kluft
# version: 04.05.2015
#
# purpose: script to download and show den Top N of someones last.fm account

# get username
if ( ! getopts ":u:" opt );then
    echo "ERROR: No user specified"
    echo "USAGE: $0 -u <username>"
    exit 1
fi

while getopts ":u:" opt; do
    case $opt in
        u)  user=$OPTARG ;;
        \?) echo "ERROR: Invalid option: $OPTARG"
            echo "USAGE: $0 -u <username>"
            exit 1 ;;
        :)  echo "ERROR: No user specified"
            echo "USAGE: $0 <username>"
            exit 1 ;;
  esac
done

# turning hourglass for loading-message
hourglass(){
    echo -e \\r"Load |" \\c; \
    sleep 0.2;echo -e \\r"Load /" \\c; \
    sleep 0.2;echo -e \\r"Load â€”" \\c; \
    sleep 0.2;echo -e \\r"Load \\" \\c; \
    sleep 0.2
}

# download website data
tmp1=$(mktemp)
tmp2=$(mktemp)

# download user's charts
wget -O $tmp1 -q  http://www.lastfm.de/user/$user/charts?rangetype=week&subtype=artists | \
    while [ $(pidof wget) ];do hourglass; done

# download start page for last song
wget -O $tmp2 -q http://www.lastfm.de/user/$user | while [ $(pidof wget) ];do hourglass; done


# get last track
band=$(grep "/music/" $tmp2 | head -2 | grep '">' | cut -d ">" -f 2 | cut -d "<" -f 1 | sed 's/amp;//g')
song=$(grep "/music/" $tmp2 | head -2 | grep '">' | cut -d ">" -f 4 | cut -d "<" -f 1 | sed 's/amp;//g')

# when was the last song played
# usage of head instead of cat because of friends in the side bar that could listen to songs
if [[ ! -z $(head -n 500 $tmp2 | grep "Hört gerade") ]];then
    when="Spielt gerade"
elif [[ ! -z $(head -n 500 $tmp2 | grep "Soeben") ]];then
    when="Spielte soeben"
else
    when=$(grep "date" $tmp2 | cut -d ">" -f 2 | cut -d "<" -f 1 | head -2 | tail -1)
fi


# time range of given charts (e.g. Last Week)
time=$(echo $(grep "current first chart" $tmp1 | cut -d ">" -f 3 | cut -d "<" -f 1))

# print header bar
echo -e \\r"\033[1;37;41m========== $user: $time ==========\033[0m "\\n

# print a sorted list of artists played in the last week
grep "title" $tmp1 | awk 'NR >= 6' | cut -d "=" -f 3 | cut -d ">" -f 1 | cut -d '"' -f 2 | head -10 | \
    sed -e 's/amp;//g' \
        -e 's/, /\t/' \
        -e 's/ Mal gespielt/x/' \
        -e 's/einx/1x/' \
        -e 's/Der Scrobbler/.../g' \
        -e 's/Der iOS-Scrobbler/Keine weiteren Bands im Zeitraum/g' | \
    cat -n | column -t -s $'\t'

# print last song
echo -e \\n"\033[1;37m\\t$when:\\n\\t$band - $song\033[0m "\\n

# underbar with length of topbar
echo -e "\033[1;37;41m$(echo "========== $user: $time ==========" | sed 's/./=/g')\033[0m"

