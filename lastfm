#!/bin/bash
# author: Lukas Kluft
# version: 22.08.2014
#
# purpose: script to download and show den Top N of someones last.fm account

# set N value for Top N
if [ ! -z "$1" ];then
    if [ "$1" -lt 1 ];then # if N<1 set N=1
        n=1
    else
        n=$1
    fi
else
    n=10 # if no N is given set N=10
fi

# set username
echo -e "Username eingeben:" \\c
read u

# download the charts and show "hour glass" while loading
range=week      # default time range for charts
type=artists    # chart type
wget -O temp -q  http://www.lastfm.de/user/$u/charts?rangetype=$range&subtype=$type | \
    while [ $(ps -ef | grep wget | grep -v grep | wc -l) -eq 1 ];do echo -e \\r"Load |" \\c; \
    sleep 0.2;echo -e \\r"Load /" \\c;sleep 0.2;echo -e \\r"Load â€”" \\c; \
    sleep 0.2;echo -e \\r"Load \\" \\c;sleep 0.2;done

# download start page for last song
wget -O temp2 -q http://www.lastfm.de/user/$u | \
    while [ $(ps -ef | grep wget | grep -v grep | wc -l) -eq 1 ];do echo -e \\r"Load |" \\c; \
    sleep 0.2;echo -e \\r"Load /" \\c;sleep 0.2;echo -e \\r"Load â€”" \\c; \
    sleep 0.2;echo -e \\r"Load \\" \\c;sleep 0.2;done

# get last song and interpreter
band=$(cat temp2 | grep /music/ | head -2 | grep '">' | cut -d ">" -f 2 | cut -d "<" -f 1 | sed 's/amp;//g')
song=$(cat temp2 | grep /music/ | head -2 | grep '">' | cut -d ">" -f 4 | cut -d "<" -f 1 | sed 's/amp;//g')

# when was the last song played
# usage of head instead of cat because of friends in the side bar that could listen to songs
when1=$(head -n 500 temp2 | grep "Hört gerade")
when2=$(head -n 500 temp2 | grep "Soeben")

# check which when variable is not empty
if [ ! -z "$when1" ];then 
    when="Spielt gerade"
elif [ ! -z "$when2" ];then
    when="Spielte soeben"
else
    when=$(cat temp2 | grep "date" | cut -d ">" -f 2 | cut -d "<" -f 1 | head -2 | tail -1)
fi

# time range of given charts (e.g. Last Week)
time=$(cat temp | grep "current first chart" | cut -d ">" -f 3 | cut -d "<" -f 1)
time=$(echo $time)

# top 3 artists
first=$(cat temp | grep title | awk 'NR >= 6' | cut -d "=" -f 3 | cut -d ">" -f 1 | cut -d '"' -f 2 | sed 's/amp;//g' | awk 'FNR == 1')

second=$(cat temp | grep title | awk 'NR >= 6' | cut -d "=" -f 3 | cut -d ">" -f 1 | cut -d '"' -f 2 | sed 's/amp;//g' | \
    sed 's/Der Scrobbler/.../g' | sed 's/Der iOS-Scrobbler/Keine weiteren Bands im Zeitraum/g' | awk 'FNR == 2')

third=$(cat temp | grep title | awk 'NR >= 6' | cut -d "=" -f 3 | cut -d ">" -f 1 | cut -d '"' -f 2 | sed 's/amp;//g' | \
    sed 's/Der Scrobbler/.../g' | sed 's/Der iOS-Scrobbler/Keine weiteren Bands im Zeitraum/g' | awk 'FNR == 3')


# print header bar
if [ ! -z "$1" ] && [ "$1" -lt 3 ]; then
    echo -e \\r"\033[1;37;41m========== $u's Top 3: $time ==========\033[0m "\\n
else
    echo -e \\r"\033[1;37;41m========== $u's Top $n: $time ==========\033[0m "\\n
fi

# highlight top 3
echo -e "\033[1;34m$first \033[0m "
echo -e "\033[1;32m$second \033[0m "
echo -e "\033[1;36m$third \033[0m "

# print remaining artists
cat temp | grep title | awk 'NR >= 6' | cut -d "=" -f 3 | cut -d ">" -f 1 | cut -d '"' -f 2 | head -$n | sed 's/amp;//g' | \
    sed 's/Der Scrobbler/.../g' | sed 's/Der iOS-Scrobbler/Keine weiteren Bands im Zeitraum/g' | awk "FNR > 3"

# print last song
echo -e \\n"\033[1;37m\\t$when:\\n\\t$band - $song\033[0m "\\n

# underbar with length of topbar
echo -e "\033[1;37;41m$(echo "========== $u=s Top $n= $time ==========" | sed 's/./=/g')\033[0m"

# remove temporary files
rm temp temp2
