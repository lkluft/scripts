#!/bin/bash
# author: Lukas Kluft
# version: 17.09.2014
#
# purpose: check if an ARTS update is available. if so, download
#           the sourcefiles and build the ARTS executable.
#           also update the ARTS syntax highlighting for vim and
#           the arts-xml-data directory. show last ChangeLog entry

# download the latest sourcefiles using subversion
cd /home/zmaw/u300509/lkluft/arts/
echo Aktuelles Verzeichnis ist $(pwd)

if [[ $(svn info | grep Revision) == $(svn info -r HEAD | grep Revision) ]];then
    echo ARTS ist auf dem aktuellen Stand.
else
    echo Download der aktuellsten sourcefiles.
    svn update

    # get number of cores that are free to use (use halt of them)
    n=$(($(($(nproc)-$(cat /proc/loadavg | cut -d "." -f 1)))/2))

    if [ $n -le 6 ];then
        n=6
    fi

    # build the executable
    cd build
    echo Aktuelles Verzeichnis ist $(pwd)
    echo Kompilieren der executable mit $n CPU-Cores.
    make -j$n arts

    # success message
    if [ $? = 0 ];then
        echo ARTS Update erfolgreich durchgef√ºhrt.
    else
        echo Fehler beim ARTS Update.
    fi

    # update vim syntax highlightin for arts (if script is existing)
    if [ $(which update-vim-arts-syntax) ];then
        echo -e "\nvim Syntax Highlighting wird aktualisiert."
        update-vim-arts-syntax

        # succes message
        if [ $? = 0 ];then
            echo vim syntax file erfolgreich aktualisiert.
        else
            echo Fehler bei Aktualisierung des vim syntax files.
        fi
    fi

    # update arts-xml-data
    cd /home/zmaw/u300509/lkluft/arts-xml-data/
    echo -e "\nAktuelles Verzeichnis ist $(pwd)"
    echo Download der aktuellsten arts-xml-data.
    svn update

    # print ChangeLog
    CL="/home/zmaw/u300509/lkluft/arts/ChangeLog"
    echo
    head -n $(( $(grep -n ^2 $CL | head -n 2 | tail -n 1 | cut -d ":" -f 1) -1)) $CL
fi
