#!/bin/bash
# author: Lukas Kluft
# version: 08.09.2014
#
# purpose: update the sourcefiles and build the executable of ARTS.
#           also update the ARTS syntax highlighting for vim and
#           the arts-xml-data directory

# download the latest sourcefiles using subversion
cd /home/zmaw/u300509/lkluft/arts/
echo Aktuelles Verzeichnis ist $(pwd)

if [[ $(svn info | grep Revision) == $(svn info -r HEAD | grep Revision) ]];then
    echo -e \\tARTS ist auf dem aktuellen Stand.
else
    echo -e \\tDownload der aktuellsten sourcefiles.
    svn update

    # get number of cores that are free to use (use halt of them)
    n=$(($(($(nproc)-$(cat /proc/loadavg | cut -d "." -f 1)))/2))

    if [ $n -le 0 ];then
        n=1
    fi

    # build the executable
    cd build
    echo Aktuelles Verzeichnis ist $(pwd)
    echo -e \\tKompilieren der executable mit $n CPU-Cores.
    make -j$n arts

    # success message
    if [ $? = 0 ];then
        echo -e \\tARTS Update erfolgreich durchgef√ºhrt.
    else
        echo -e \\tFehler beim ARTS Update.
    fi

    # update vim syntax highlightin for arts (if script is existing)
    if [ $(which update-vim-arts-syntax) ];then
        echo -e \\tvim Syntax Highlighting wird aktualisiert.
        update-vim-arts-syntax

        # succes message
        if [ $? = 0 ];then
            echo -e \\tvim syntax file erfolgreich aktualisiert.
        else
            echo -e \\t Fehler bei Aktualisierung des vim syntax files.
        fi
    fi

    # update arts-xml-data
    cd /home/zmaw/u300509/lkluft/arts-xml-data/
    echo Aktuelles Verzeichnis ist $(pwd)
    echo -e \\tDownload der aktuellsten xml-data.
    svn update
fi
